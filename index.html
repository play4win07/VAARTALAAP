<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced 2-Person Video Call</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: linear-gradient(135deg,#020617,#0f172a);
      color: #fff;
    }
    header {
      padding: 12px;
      text-align: center;
      font-weight: 700;
      background: #020617;
    }
    .app {
      max-width: 420px;
      margin: auto;
      padding: 12px;
    }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .room {
      font-size: 22px;
      letter-spacing: 3px;
      text-align: center;
    }
    input, button, select {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
    }
    button { background:#22c55e; font-weight:700; cursor:pointer; }
    button.secondary { background:#334155; }
    .videos {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    video {
      width: 100%;
      max-width: 190px;
      aspect-ratio: 4/3;
      border-radius: 12px;
      background: #000;
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .controls button { flex:1; }
    .filters {
      margin-top: 8px;
      display: grid;
      gap: 6px;
    }
    .status {
      font-size: 12px;
      text-align: center;
      color: #93c5fd;
    }
  </style>
</head>
<body>
<header>ðŸ“± Advanced Video Call</header>
<div class="app">

  <div class="card">
    <div style="text-align:center">Your Room Code</div>
    <div class="room" id="roomCode">-----</div>
    <div class="status" id="shareLink"></div>
  </div>

  <div class="card">
    <input id="joinInput" placeholder="Enter 5â€“6 letter code" />
    <button id="joinBtn" disabled>Join Call</button>
    <div class="status" id="status">Initializingâ€¦</div>
  </div>

  <div class="videos">
    <video id="myVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div class="controls">
    <button id="muteBtn" class="secondary">ðŸ”‡ Mute</button>
    <button id="camBtn" class="secondary">ðŸ“· Off</button>
  </div>

  <div class="card filters">
    <b>ðŸŽ¨ Video Filters</b>
    <select id="videoFilter">
      <option value="none">Normal</option>
      <option value="brightness(1.2) contrast(1.2)">HD Enhance</option>
      <option value="brightness(1.3) saturate(1.4)">Glow / Fair</option>
      <option value="contrast(1.5) saturate(1.2)">Sharp Look</option>
    </select>

    <b>ðŸŽ¤ Voice</b>
    <select id="voiceFilter">
      <option value="normal">Normal</option>
      <option value="female">Female-like (Pitch â†‘)</option>
      <option value="deep">Deep (Pitch â†“)</option>
    </select>
  </div>
</div>

<script>
/* =====================
   Utility: short room code
===================== */
function makeCode(len=6){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c='';
  for(let i=0;i<len;i++) c+=chars[Math.floor(Math.random()*chars.length)];
  return c;
}

/* =====================
   Peer with short ID
===================== */
const ROOM = makeCode(6);
const peer = new Peer(ROOM, {debug:1});

document.getElementById('roomCode').innerText = ROOM;
const shareURL = location.origin + location.pathname + '?room=' + ROOM;
document.getElementById('shareLink').innerText = 'Share link: ' + shareURL;

// auto-fill from link
const params = new URLSearchParams(location.search);
if(params.get('room')){
  document.getElementById('joinInput').value = params.get('room');
}

/* =====================
   Media setup
===================== */
const myVideo = document.getElementById('myVideo');
const remoteVideo = document.getElementById('remoteVideo');
let stream, audioTrack, videoTrack;
let muted=false, camOff=false;

const statusEl = document.getElementById('status');
const joinBtn = document.getElementById('joinBtn');

navigator.mediaDevices.getUserMedia({
  video: { width:{ideal:1280}, height:{ideal:720} },
  audio: { noiseSuppression:true, echoCancellation:true }
}).then(s=>{
  stream=s;
  myVideo.srcObject=s;
  audioTrack=s.getAudioTracks()[0];
  videoTrack=s.getVideoTracks()[0];
  joinBtn.disabled=false;
  statusEl.innerText='Ready';
}).catch(()=>statusEl.innerText='Camera/Mic blocked');

/* =====================
   Calls
===================== */
peer.on('call', call=>{
  call.answer(stream);
  call.on('stream', rs=>remoteVideo.srcObject=rs);
});

joinBtn.onclick=()=>{
  const code=document.getElementById('joinInput').value.trim().toUpperCase();
  if(!code) return alert('Enter code');
  const call=peer.call(code, stream);
  if(!call) return;
  call.on('stream', rs=>remoteVideo.srcObject=rs);
};

/* =====================
   Controls
===================== */
document.getElementById('muteBtn').onclick=e=>{
  muted=!muted;
  audioTrack.enabled=!muted;
  e.target.innerText=muted?'ðŸ”Š Unmute':'ðŸ”‡ Mute';
};

document.getElementById('camBtn').onclick=e=>{
  camOff=!camOff;
  videoTrack.enabled=!camOff;
  e.target.innerText=camOff?'ðŸ“· On':'ðŸ“· Off';
};

/* =====================
   Video filters (real-time)
===================== */
document.getElementById('videoFilter').onchange=e=>{
  myVideo.style.filter=e.target.value==='none'?'none':e.target.value;
};

/* =====================
   Voice pitch (WORKING)
===================== */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioCtx();
let source, processor;

function applyPitch(type){
  if(!stream) return;
  if(source) source.disconnect();
  if(processor) processor.disconnect();

  source = ctx.createMediaStreamSource(stream);
  processor = ctx.createBiquadFilter();

  if(type==='female'){
    processor.type='highshelf';
    processor.frequency.value=1000;
    processor.gain.value=8;
  } else if(type==='deep'){
    processor.type='lowshelf';
    processor.frequency.value=300;
    processor.gain.value=8;
  } else {
    processor.type='allpass';
  }

  source.connect(processor);
  processor.connect(ctx.destination);
}

document.getElementById('voiceFilter').onchange=e=>{
  applyPitch(e.target.value);
};
</script>
</body>
</html>
